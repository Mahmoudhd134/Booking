@using Microsoft.AspNetCore.Mvc.TagHelpers
@model Booking.Mvc.Controllers.AddBookingViewModel

@{
    ViewData["Title"] = "Add Booking";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Popper and Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        /* Additional custom styling if needed */
        .custom-responsive {
            overflow-x: auto;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2>Add Booking</h2>
    <form id="bookingForm">
        <!-- Customer Dropdown -->
        <div class="form-group">
            <label for="customerSelect">Select Customer</label>
            <select id="customerSelect" class="form-control" required>
                <option value="">-- Select a customer --</option>
                @foreach (var customer in Model.Customers)
                {
                    <option value="@customer.NId" data-phone="@customer.PhoneNumber">
                        @customer.Name
                    </option>
                }
            </select>
        </div>

        <!-- Hotel Dropdown -->
        <div class="form-group">
            <label for="hotelSelect">Select Hotel</label>
            <select id="hotelSelect" class="form-control" required>
                <option value="">-- Select a hotel --</option>
                @foreach (var hotel in Model.Hotels)
                {
                    <option value="@hotel.Id">@hotel.BranchName</option>
                }
            </select>
        </div>

        <!-- Check In / Check Out Dates -->
        <div class="form-group">
            <label for="checkInInput">Check In</label>
            <input type="datetime-local" id="checkInInput" class="form-control" required/>
        </div>
        <div class="form-group">
            <label for="checkOutInput">Check Out</label>
            <input type="datetime-local" id="checkOutInput" class="form-control" required/>
        </div>

        <!-- Room Quantity Inputs -->
        <div class="form-group">
            <label>Number of Rooms Required</label>
            <div class="row">
                <div class="col">
                    <label for="singleRooms">Single</label>
                    <input type="number" id="singleRooms" class="form-control" min="0" value="0"/>
                </div>
                <div class="col">
                    <label for="doubleRooms">Double</label>
                    <input type="number" id="doubleRooms" class="form-control" min="0" value="0"/>
                </div>
                <div class="col">
                    <label for="suitRooms">Suit</label>
                    <input type="number" id="suitRooms" class="form-control" min="0" value="0"/>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Check Availability</button>
    </form>

    <!-- Error message container -->
    <div id="errorMessage" class="mt-3"></div>

    <!-- Container to display the available rooms as per request -->
    <div id="roomsContainer" class="mt-4"></div>
</div>

<!-- Booking Modal (readonly) -->
<div class="modal fade" id="bookingModal" tabindex="-1" role="dialog" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">Booking Summary</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="modalCloseBtn">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Readonly Booking Summary -->
                <p>
                    <strong>Customer:</strong> <span id="modalCustomer"></span>
                </p>
                <p>
                    <strong>Hotel:</strong> <span id="modalHotel"></span>
                </p>
                <p>
                    <strong>Check In:</strong> <span id="modalCheckIn"></span>
                </p>
                <p>
                    <strong>Check Out:</strong> <span id="modalCheckOut"></span>
                </p>
                <!-- Wrap the summary table with a responsive div -->
                <div class="table-responsive">
                    <div id="modalRoomsSummary"></div>
                </div>
                <div id="modalPriceSummary" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmBooking" disabled>Confirm Booking</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variable to store available rooms for the current query.
    var allAvailableRooms = null;
    var currentQuery = { hotelId: null, checkIn: null, checkOut: null };
    var finalBookingRequest = null;

    // Map room type numeric value to string.
    function roomTypeToString(roomType) {
        switch (roomType) {
            case 1: return "Single";
            case 2: return "Double";
            case 3: return "Suit";
            default: return "Unknown";
        }
    }

    $(document).on("click", "[data-dismiss='modal']", function () {
        $('#bookingModal').modal('hide');
    });

    // Generates a dropdown element with options 0 to maxValue.
    function generateDropdown(maxValue, cssClass) {
        var selectHtml = "<select class='" + cssClass + " form-control'>";
        for (var i = 0; i <= maxValue; i++) {
            selectHtml += "<option value='" + i + "'>" + i + "</option>";
        }
        selectHtml += "</select>";
        return selectHtml;
    }

    // Filter and display rooms based on requested room counts.
    function filterAndDisplayRooms() {
        var requestedSingle = parseInt($("#singleRooms").val());
        var requestedDouble = parseInt($("#doubleRooms").val());
        var requestedSuit = parseInt($("#suitRooms").val());
        
        if (requestedSingle === 0 && requestedDouble === 0 && requestedSuit ===0){
            $("#roomsContainer").empty();
            return
        }

        var availableRooms = { 1: [], 2: [], 3: [] };
        $.each(allAvailableRooms, function (i, room) {
            if (room.roomType in availableRooms) {
                availableRooms[room.roomType].push(room);
            }
        });

        var errorMessages = [];
        if (requestedSingle > availableRooms[1].length) {
            errorMessages.push("Not enough Single rooms available. Requested: " + requestedSingle + ", Available: " + availableRooms[1].length);
        }
        if (requestedDouble > availableRooms[2].length) {
            errorMessages.push("Not enough Double rooms available. Requested: " + requestedDouble + ", Available: " + availableRooms[2].length);
        }
        if (requestedSuit > availableRooms[3].length) {
            errorMessages.push("Not enough Suit rooms available. Requested: " + requestedSuit + ", Available: " + availableRooms[3].length);
        }

        if (errorMessages.length > 0) {
            $("#errorMessage").html('<p class="text-danger">' + errorMessages.join("<br>") + '</p>');
            $("#roomsContainer").empty();
            return;
        }
        $("#errorMessage").empty();

        // Build HTML to display room details with dropdowns for selecting adults/children.
        var html = '<h3>Selected Available Rooms</h3>';
        // Wrap the table with a responsive div.
        html += '<div class="table-responsive">';
        html += '<table class="table table-bordered">';
        html += '<thead><tr>' +
            '<th>Room ID</th>' +
            '<th>Room Type</th>' +
            '<th>Adults Allowed</th>' +
            '<th>Children Allowed</th>' +
            '<th>Price Per Night</th>' +
            '<th>Select Adults</th>' +
            '<th>Select Children</th>' +
            '</tr></thead>';
        html += '<tbody>';

        function addRows(roomType, requestedCount) {
            if (requestedCount > 0) {
                var displayRooms = availableRooms[roomType].slice(0, requestedCount);
                $.each(displayRooms, function (i, room) {
                    html += '<tr data-roomid="' + room.id + '">';
                    html += '<td>' + room.id + '</td>';
                    html += '<td>' + roomTypeToString(room.roomType) + '</td>';
                    html += '<td>' + room.adults + '</td>';
                    html += '<td>' + room.children + '</td>';
                    html += '<td>' + room.pricePerNight + '</td>';
                    html += '<td>' + generateDropdown(room.adults, "adult-select") + '</td>';
                    html += '<td>' + generateDropdown(room.children, "child-select") + '</td>';
                    html += '</tr>';
                });
            }
        }

        addRows(1, requestedSingle);
        addRows(2, requestedDouble);
        addRows(3, requestedSuit);

        html += '</tbody></table></div>';
        html += '<button id="bookButton" class="btn btn-success mt-3">Book</button>';
        $("#roomsContainer").html(html);
    }

    // Load available rooms from the API if not already loaded.
    function loadAvailableRooms(callback) {
        var hotelId = $("#hotelSelect").val();
        var checkIn = $("#checkInInput").val();
        var checkOut = $("#checkOutInput").val();

        if (!hotelId || !checkIn || !checkOut) {
            $("#errorMessage").html('<p class="text-danger">Please select a hotel and specify both check-in and check-out dates.</p>');
            return;
        }

        if (currentQuery.hotelId !== hotelId || currentQuery.checkIn !== checkIn || currentQuery.checkOut !== checkOut) {
            currentQuery = { hotelId: hotelId, checkIn: checkIn, checkOut: checkOut };
            allAvailableRooms = null;
        }

        if (allAvailableRooms !== null) {
            if (callback) callback();
            return;
        }

        var url = 'http://localhost:5104/api/Hotel/' + hotelId + '/available-rooms';
        $.ajax({
            url: url,
            type: 'GET',
            data: { checkIn: checkIn, checkOut: checkOut },
            success: function (response) {
                allAvailableRooms = response;
                if (callback) callback();
            },
            error: function () {
                $("#roomsContainer").html('<p class="text-danger">An error occurred while fetching available rooms.</p>');
            }
        });
    }

    // Build a readonly summary table for the modal.
    function buildModalSummary() {
        var summaryHtml = "<div class='table-responsive'><table class='table table-bordered'>";
        summaryHtml += "<thead><tr>" +
            "<th>Room ID</th>" +
            "<th>Room Type</th>" +
            "<th>Adults Allowed</th>" +
            "<th>Children Allowed</th>" +
            "<th>Price Per Night</th>" +
            "<th>Selected Adults</th>" +
            "<th>Selected Children</th>" +
            "</tr></thead><tbody>";
        $("#roomsContainer table tbody tr").each(function () {
            var roomId = $(this).find("td:eq(0)").text();
            var roomType = $(this).find("td:eq(1)").text();
            var adultsAllowed = $(this).find("td:eq(2)").text();
            var childrenAllowed = $(this).find("td:eq(3)").text();
            var pricePerNight = $(this).find("td:eq(4)").text();
            var selectedAdults = $(this).find("td:eq(5) select").val();
            var selectedChildren = $(this).find("td:eq(6) select").val();

            summaryHtml += "<tr>";
            summaryHtml += "<td>" + roomId + "</td>";
            summaryHtml += "<td>" + roomType + "</td>";
            summaryHtml += "<td>" + adultsAllowed + "</td>";
            summaryHtml += "<td>" + childrenAllowed + "</td>";
            summaryHtml += "<td>" + pricePerNight + "</td>";
            summaryHtml += "<td>" + selectedAdults + "</td>";
            summaryHtml += "<td>" + selectedChildren + "</td>";
            summaryHtml += "</tr>";
        });
        summaryHtml += "</tbody></table></div>";
        return summaryHtml;
    }

    // Send POST request to calculate the booking price.
    function sendPriceRequest(modalData) {
        $("#confirmBooking").prop("disabled", true);
        $("#modalPriceSummary").html("<p>Calculating price...</p>");
        $.ajax({
            url: 'http://localhost:5104/api/Booking/price',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(modalData),
            success: function (priceData) {
                var priceHtml = "<p><strong>Discount:</strong> " + priceData.discount + "</p>" +
                    "<p><strong>Price Before Discount:</strong> " + priceData.priceBeforeDiscount + "</p>" +
                    "<p><strong>Price After Discount:</strong> " + priceData.priceAfterDiscount + "</p>";
                $("#modalPriceSummary").html(priceHtml);
                $("#confirmBooking").prop("disabled", false);
            },
            error: function () {
                $("#modalPriceSummary").html('<p class="text-danger">Failed to calculate price.</p>');
            }
        });
    }

    // When the Book button is clicked, open the modal and build the summary.
    $(document).on("click", "#bookButton", function () {
        var customerSelect = $("#customerSelect option:selected");
        var customerNId = customerSelect.val();
        var customerName = customerSelect.text();
        var customerPhone = customerSelect.data("phone");
        $("#modalCustomer").text(customerName + " (" + customerPhone + ")");

        var hotelText = $("#hotelSelect option:selected").text();
        var checkIn = $("#checkInInput").val();
        var checkOut = $("#checkOutInput").val();
        $("#modalHotel").text(hotelText);
        $("#modalCheckIn").text(checkIn);
        $("#modalCheckOut").text(checkOut);

        // Build a read-only summary table.
        var summaryTableHtml = buildModalSummary();
        $("#modalRoomsSummary").html(summaryTableHtml);

        // Build the request body for price calculation and final booking.
        finalBookingRequest = {
            customerNId: customerNId,
            hotelId: parseInt($("#hotelSelect").val()),
            items: [],
            checkIn: new Date(checkIn).toISOString(),
            checkOut: new Date(checkOut).toISOString()
        };

        $("#roomsContainer table tbody tr").each(function () {
            var roomId = parseInt($(this).find("td:first").text());
            var selectedAdults = parseInt($(this).find("td:eq(5) select").val());
            var selectedChildren = parseInt($(this).find("td:eq(6) select").val());
            finalBookingRequest.items.push({
                roomId: roomId,
                adults: selectedAdults,
                children: selectedChildren
            });
        });

        $("#bookingModal").modal("show");
        sendPriceRequest(finalBookingRequest);
    });

    // When the Confirm Booking button is clicked, send the final booking request.
    $("#confirmBooking").on("click", function () {
        $("#confirmBooking").prop("disabled", true);
        $("#modalPriceSummary").append("<p>Confirming booking...</p>");
        $.ajax({
            url: 'http://localhost:5104/api/Booking',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(finalBookingRequest),
            success: function (bookingResponse) {
                console.log("Booking confirmed successfully:", bookingResponse);
                $("#bookingModal").modal("hide");
            },
            error: function () {
                console.error("Failed to confirm booking.");
                $("#modalPriceSummary").append("<p class='text-danger'>Failed to confirm booking.</p>");
                $("#confirmBooking").prop("disabled", false);
            }
        });
    });

    $(document).ready(function () {
        $("#bookingForm").on("submit", function (e) {
            e.preventDefault();
            loadAvailableRooms(filterAndDisplayRooms);
        });

        $("#singleRooms, #doubleRooms, #suitRooms").on("input", function () {
            if (allAvailableRooms !== null) {
                filterAndDisplayRooms();
            }
        });

        $("#hotelSelect, #checkInInput, #checkOutInput").on("change", function () {
            allAvailableRooms = null;
            $("#roomsContainer").empty();
            $("#errorMessage").empty();
        });
    });
</script>
</body>
</html>